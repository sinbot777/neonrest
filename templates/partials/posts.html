<!-- templates/partials/posts.html -->
{# Make sure posts.html works with modular includes #}
{% set posts = _posts if _posts is defined else posts %}
{% set post_reactors = _reactors if _reactors is defined else {} %}
{% set VALID_REACTS = _reacts if _reacts is defined else [] %}
{% set viewer_id = _viewer_id if _viewer_id is defined else None %}


{% for post in posts %}
<div class="post-preview{% if post.is_guestbook_outbound %} guestbook-outbound{% endif %}">
  <div class="post-header">
    <img src="{{ post.author_avatar or '/static/default-avatar.png' }}" alt="avatar" class="avatar-img small">
    <div class="post-user-meta">
      {% if post.is_guestbook_outbound and post.target_handle %}
        <strong>
          <a href="/@{{ post.author_handle }}" class="user-handle">@{{ post.author_handle }}</a> ➔
          <a href="/@{{ post.target_handle }}" class="user-handle">@{{ post.target_handle }}</a>
        </strong>
      {% else %}
        <strong>
          <a href="/@{{ post.author_handle }}" class="user-handle">@{{ post.author_handle }}</a>
        </strong>
        {% if post.author_codename %}
          <span class="user-codename">({{ post.author_codename }})</span>
        {% endif %}
      {% endif %}

      <div class="post-meta-row">
        <span class="post-date">{{ post.created_at }}</span> ·
        <strong>Vibes:</strong>
        {% if post.vibes %}
          {% for vibe in post.vibes.split(',') %}
            <a href="/vibe/{{ vibe.strip() | urlencode }}">
              <span class="vibe-pill">{{ vibe.strip() }}</span>
            </a>
          {% endfor %}
        {% else %}
          <span>—</span>
        {% endif %}
        |
        <strong>Circle:</strong> {{ post.circle or '—' }}
      </div>
    </div>

    {% if viewer_id == post.user_id %}
        <div class="post-actions">
          <button class="icon-button" onclick="togglePostMenu(this)">⋮</button>
          <div class="post-dropdown" style="display: none;">
            <a href="/edit_post/{{ post.id }}">Edit</a>
            <form method="POST" action="/delete_post/{{ post.id }}" style="display:inline;" onsubmit="return confirm('Delete this post?');">
              <button type="submit" class="link-button">Delete</button>
            </form>
          </div>
        </div>
    {% endif %}
  </div>

<div class="post-content">{{ post.html_content | safe }}</div>

<div class="post-reactions-box react-form" data-post-id="{{ post.id }}">
  {% for react in VALID_REACTS %}
    {% set count = post.reaction_counts[react] if post.reaction_counts and react in post.reaction_counts else 0 %}
    {% set hover = _reactors.get(post.id, {}).get(react, []) | join(', ') %}
    <button type="button" class="icon-button react-btn" data-emoji="{{ react }}"
            title="{{ hover if hover else '' }}">
      {{ react }}{% if count %}<sub>{{ count }}</sub>{% endif %}
    </button>
  {% endfor %}
</div>

</div>
{% endfor %}
